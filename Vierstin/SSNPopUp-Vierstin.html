<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>Social Stream - Custom Highlight</title>
    <meta name="robots" content="noindex">
    <style>
        /* -- TEMA KUSTOM FINAL ANDA -- */
        @import url('https://fonts.googleapis.com/css2?family=Radley:wght@600;700;900&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            background: transparent;
            font-family: 'Radley', serif;
            overflow: hidden;
        }

        #output {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            max-width: min(90vw, 500px);
            width: 100%;
            display: flex;
            overflow: visible;
        }

        /* Ini adalah nama class yang dibuat oleh JS di bawah */
        .chat-message {
            padding: 8px 8px;
            opacity: #ffffff;
            border-radius: 32px;
            animation: bounceIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            position: relative;
            display: block;
            width: 100%;
        }

        .badge {
            font-weight: 900; color: #ffffff; padding: 6px 20px;
            border-radius: 12px; font-size: 20px; position: absolute;
            z-index: 3; background-color: #222222;
            white-space: nowrap; overflow: visible; text-overflow: ellipsis; max-width: 180px;
            top: -42px; left: 50%; transform: translateX(-50%);
            max-width: 100%;
        }

        .message {
            font-weight: 700; background: #222222; color: #ffffff;
            font-size: 30px; padding: 18px 38px; text-align: center;
            border-radius: 24px;
            box-sizing: border-box; overflow-wrap: break-word;
            position: relative; display: block;
            width: 100%;
        }

        .message img {
            /* Atur ukuran yang diinginkan */
            width: 40px !important;
            height: 40px !important;

            /* Jaga agar tetap sejajar dengan teks */
            vertical-align: middle !important;
            
            /* Perbaikan visual minor */
            display: inline-block !important;
            margin: -4px 2px 0 2px !important;
        }

        /* Ornamen dasar */
        .message::before, .message::after, .badge::before, .badge::after, .ornament-extra-1, .ornament-extra-2 {
            content: '';
            position: absolute;
            background-size: contain;
            background-repeat: no-repeat;
            transform-origin: bottom center;
        }

        /* Owner */
        .chat-message.owner {
        background-image: url('https://raw.githubusercontent.com/renzo-gith/SocialStreamNinja/378d5db63cdc88f9195accfa5465dbb051444cb7/Vierstin/Asset/ornament-bg.svg'), 
        linear-gradient(to bottom, #FCC8C4, #E46870);
        background-repeat: no-repeat, no-repeat;
        background-position: center, center;
        background-size: clamp(56px, 50%, 80vw) auto, cover;
        padding: 8px; 
        border-radius: 32px;
        margin-bottom: 10px; 
        }
        .chat-message.owner .message {
        background-image: linear-gradient(to bottom, #FCC8C4, #E46870);
        border: 2px solid #ffffff;
        color: #ffffff;
        }
        .chat-message.owner .badge {
        background-image: linear-gradient(to bottom, #FCC8C4, #E46870);
        border: 1px solid #ffffff;
        color: #ffffff;
        }
        .chat-message.owner .message::before {
        background-image: url('');
        width: 48px; height: 32px; top: -11px; right: -11px; z-index: 4;
        }
        .chat-message.owner .message::after {
        background-image: url('');
        width: 28px; height: 20px; bottom: -2px; right: -10px; z-index: 4;
        animation: sway 1s ease-in-out infinite alternate;
        }
        .chat-message.owner .badge::before {
        background-image: url('https://raw.githubusercontent.com/renzo-gith/SocialStreamNinja/378d5db63cdc88f9195accfa5465dbb051444cb7/Vierstin/Asset/tangkai%2012x10.svg');
        width: 26px; height: 21px; top: -12px; left: -2px; z-index: 5;
        transform: rotate(-35deg);
        }
        .chat-message.owner .badge::after {
        background-image: url('https://raw.githubusercontent.com/renzo-gith/SocialStreamNinja/378d5db63cdc88f9195accfa5465dbb051444cb7/Vierstin/Asset/star%20putih.svg');
        width: 20px; height: 20px; top: 50%; right: -10px;transform: translateY(-50%); z-index: 5;
        }

        /* Moderator */
        .chat-message.moderator {
        background-image: linear-gradient(to bottom, #E46870, #5E0B15);
        padding: 2px;
        border: 8px solid #4B1F1B;
        border-radius: 34px;
        margin-bottom: 10px; 
        }
        .chat-message.moderator .message {
        background-color: #4B1F1B;
        color: #F6C4C3;
        }
        .chat-message.moderator .badge {
        background-color: #4B1F1B;
        border: 1px solid #E46870;
        color: #F6C4C3;
        }
        .chat-message.moderator .message::before {
        background-image: url('https://raw.githubusercontent.com/renzo-gith/SocialStreamNinja/378d5db63cdc88f9195accfa5465dbb051444cb7/Vierstin/Asset/lumeran%20pink%2050x24.svg');
        width: 100px; height: 48px; top: -14px; left: -12px; z-index: 2;
        }
        .chat-message.moderator .badge::before {
        background-image: url('https://raw.githubusercontent.com/renzo-gith/SocialStreamNinja/378d5db63cdc88f9195accfa5465dbb051444cb7/Vierstin/Asset/tangkai%2012x10.svg');
        width: 26px; height: 21px; top: -12px; left: -2px; z-index: 5;
        transform: rotate(-35deg);
        }
        .chat-message.moderator .badge::after {
        background-image: url('https://raw.githubusercontent.com/renzo-gith/SocialStreamNinja/378d5db63cdc88f9195accfa5465dbb051444cb7/Vierstin/Asset/star%20merah.svg');
        width: 20px; height: 20px; top: 50%; right: -10px;transform: translateY(-50%); z-index: 5;
        }

        /* Member */
        .chat-message.member {
        background-image: linear-gradient(to right, #E46870, #5E0B15);
        padding: 8px; 
        border-radius: 32px;
        margin-bottom: 10px; 
        }
        .chat-message.member .message {
        background-image: linear-gradient(to right, #E46870, #5E0B15);
        border: 2px solid #F6C4C3;
        color: #F6C4C3;
        }
        .chat-message.member .badge {
        background-image: linear-gradient(to right, #E46870, #5E0B15);
        border: 1px solid #F6C4C3;
        color: #F6C4C3;
        }
        .chat-message.member .message::before {
        background-image: url('https://raw.githubusercontent.com/renzo-gith/SocialStreamNinja/378d5db63cdc88f9195accfa5465dbb051444cb7/Vierstin/Asset/lumeran%20cerah%2050x24.svg');
        width: 100px; height: 48px; top: -14px; left: -12px; z-index: 2;
        }
        .chat-message.member .message::after {
        background-image: url('');
        width: 28px; height: 20px; bottom: 2px; right: -12px; z-index: 4;
        transform: rotate(90deg);
        }
        .chat-message.member .badge::before {
        background-image: url('https://raw.githubusercontent.com/renzo-gith/SocialStreamNinja/378d5db63cdc88f9195accfa5465dbb051444cb7/Vierstin/Asset/tangkai%2012x10.svg');
        width: 26px; height: 21px; top: -12px; left: -2px; z-index: 5;
        transform: rotate(-35deg);
        }
        .chat-message.member .badge::after {
        background-image: url('https://raw.githubusercontent.com/renzo-gith/SocialStreamNinja/378d5db63cdc88f9195accfa5465dbb051444cb7/Vierstin/Asset/star%20pink.svg');
        width: 20px; height: 20px; top: 50%; right: -10px;transform: translateY(-50%); z-index: 5;
        }

        /* Regular */
        .chat-message.regular {
        background-color: #FFEBD3;
        padding: 8px;
        border-radius: 32px;
        margin-bottom: 10px; 
        }
        .chat-message.regular .message {
        background-color: #FFEBD3;
        border: 2px solid #4B1F1B;;
        color: #4B1F1B;
        }
        .chat-message.regular .badge {
        background-color: #FFEBD3;
        border: 1px solid #4B1F1B;
        color: #4B1F1B;
        }
        .chat-message.regular .message::before {
        background-image: url('https://raw.githubusercontent.com/renzo-gith/SocialStreamNinja/e2ee1873f92ea90b04dc3cce99e00f821e3d2d04/Vierstin/Asset/lumeran%20coklat%2050x24.svg');
        width: 100px; height: 48px; top: -14px; left: -12px; z-index: 2;
        }
        .chat-message.regular .badge::before {
        background-image: url('https://raw.githubusercontent.com/renzo-gith/SocialStreamNinja/e2ee1873f92ea90b04dc3cce99e00f821e3d2d04/Vierstin/Asset/tangkai%2012x10.svg');
        width: 26px; height: 21px; top: -12px; left: -2px; z-index: 5;
        transform: rotate(-35deg);
        }
        .chat-message.regular .badge::after {
        background-image: url('https://raw.githubusercontent.com/renzo-gith/SocialStreamNinja/378d5db63cdc88f9195accfa5465dbb051444cb7/Vierstin/Asset/star%20coklat.svg');
        width: 20px; height: 20px; top: 50%; right: -10px;transform: translateY(-50%); z-index: 5;
        }

        /* Animasi */
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3) translateX(-50px) translateY(50px); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { opacity: 1; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1) translateY(-50px); }
            to { opacity: 0; transform: scale(0); }
        }
    </style>
</head>
<body>
    <div id="output"></div>

    <script>
    const urlParams = new URLSearchParams(window.location.search);
    
    const App = {
        // Bagian KONEKSI dari templat asli (tetap dipertahankan)
        // =======================================================
        config: { serverURL: (urlParams.has("localserver") ? "ws://127.0.0.1:3000" : 'wss://io.socialstream.ninja') },
        state: { roomID: 'test', password: 'false' },

        init() {
            this.handleRoomIdParam(urlParams);
            this.state.password = urlParams.get('password') || 'false';
            this.initializeConnection();
        },

        initializeConnection() {
            // Logika koneksi (iframe atau websocket) tetap sama
            const iframe = document.createElement('iframe');
            iframe.src = `https://vdo.socialstream.ninja/?ln&password=${this.state.password}&notmobile&salt=vdo.ninja&label=overlay&exclude=${this.state.roomID}&scene&novideo&noaudio&cleanoutput&room=${this.state.roomID}`;
            iframe.style.cssText = "width:0;height:0;border:0;position:absolute;top:-10px;left:-10px;";
            document.body.appendChild(iframe);
            window.addEventListener('message', (e) => {
                if (e.source !== iframe.contentWindow) return;
                if (e.data?.dataReceived && ("overlayNinja" in e.data.dataReceived)){
                    this.processData({ contents: e.data.dataReceived.overlayNinja });
                }
            });
        },
        
        handleRoomIdParam(urlParams) {
             let roomID = urlParams.get('session') || urlParams.get('s') || urlParams.get('id');
             if (!roomID) {
                document.body.innerHTML = '<h1>Error: Missing ?session=ID parameter in URL</h1>';
                throw new Error("Missing session ID");
             }
             this.state.roomID = roomID;
        },

        processData(data) {
            // Jika data kosong, bersihkan layar
            if (!data || data.contents === false) {
                document.getElementById('output').innerHTML = '';
                return;
            }
            // Jika ada data, panggil showMessage
            if (data.contents) {
                this.showMessage(data.contents);
            }
        },

        // FUNGSI INTI ANDA (sudah bersih dan terintegrasi)
        // ===============================================
        // GANTIKAN FUNGSI showMessage LAMA ANDA DENGAN YANG INI
        showMessage(data) {
            const content = data;

            // --- LOGIKA BARU YANG SUDAH DISEMPURNAKAN ---

            // Prioritas 1: Event "New Subscriber" TULEN (hanya notifikasi, tanpa isi chat)
            if (content.membership && !content.chatmessage) {
                const messageContent = `
                    <div class="chat-message new-subscriber">
                        <div class="special-card new-subscriber">
                            <div class="special-badge">NEW SUBSCRIBER</div>
                            <div class="special-message">${content.chatname} ${content.membership}</div>
                        </div>
                    </div>
                `;
                document.getElementById('output').innerHTML = messageContent;
                return; // Hentikan di sini
            }

            // Prioritas 2: Donasi
            if (content.hasDonation) {
                const messageContent = `
                    <div class="chat-message donation">
                        <div class="special-card donation">
                            <div class="special-badge">DONATION</div>
                            <div class="special-message">${content.chatname} ${content.hasDonation}</div>
                        </div>
                    </div>
                `;
                document.getElementById('output').innerHTML = messageContent;
                return; // Hentikan di sini
            }

            // Jika lolos dari atas, ini adalah pesan obrolan biasa.
            // Sekarang kita tentukan gayanya.

            // 2. Deteksi Peran dari Lencana atau Properti Membership
            let roleClass = 'regular';
            
            // Deteksi Member YouTube secara spesifik
            if (content.membership === "MEMBERSHIP") {
                roleClass = 'member';
            } 
            // Deteksi peran lain dari lencana
            else if (content.chatbadges) {
                const badgeSrcs = content.chatbadges.map(badge => (badge.src || badge).toLowerCase());
                
                if (badgeSrcs.some(src => src.includes('broadcaster') || src.includes('owner'))) {
                    roleClass = 'owner';
                } else if (badgeSrcs.some(src => src.includes('moderator') || src.includes('moderater'))) {
                    roleClass = 'moderator';
                } else if (
                    badgeSrcs.some(src =>
                        src.includes('gifter') ||
                        src.includes('subscriber') ||
                        (src.includes('fans_badge') && !src.includes('grey'))
                    )
                ) {
                    roleClass = 'member';
                }
            }

            // 3. Buat HTML untuk pesan obrolan biasa dengan peran yang sesuai
            const messageContent = `
                <div class="chat-message ${roleClass}">
                    <div class="badge">${content.chatname}</div>
                    <div class="message">
                        ${content.chatmessage}
                        <span class="ornament-extra-1"></span>
                        <span class="ornament-extra-2"></span>
                    </div>
                </div>
            `;

            // 4. Tampilkan Hasilnya
            document.getElementById('output').innerHTML = messageContent;
        }
    };

    // Initialize the application when DOM is ready
    document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>